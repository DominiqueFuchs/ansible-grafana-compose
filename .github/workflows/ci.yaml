---
name: CI
on:
  pull_request:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - '.gitignore'

jobs:
  molecule:
    name: Molecule
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image:
          - dfuchs/alma-8-ansible
          - dfuchs/alma-9-ansible
          - dfuchs/debian-11-ansible
          - dfuchs/ubuntu-22.04-ansible

    steps:
      - name: Check out the codebase
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # RHEL 8 provides Python 3.6, which is not supported by ansible-core 2.17+
      - name: Set up virtual environment
        run: |
          python3 -m venv .venv
          source .venv/bin/activate
          if [[ "${{ matrix.image }}" == "dfuchs/alma-8-ansible" ]]; then
            pip install "ansible-core<2.17" ansible-lint molecule molecule-plugins[docker] docker
          else
            pip install ansible-core ansible-lint molecule molecule-plugins[docker] docker
          fi
          ansible-galaxy collection install -r requirements.yml

      - name: Run Molecule tests (default)
        run: source .venv/bin/activate && molecule test
        env:
          PY_COLORS: '1'
          ANSIBLE_FORCE_COLOR: '1'
          MOLECULE_IMAGE: ${{ matrix.image }}
          MOLECULE_PLAYBOOK: converge_default.yml

      - name: Run Molecule tests (service management)
        run: source .venv/bin/activate && molecule test
        env:
          PY_COLORS: '1'
          ANSIBLE_FORCE_COLOR: '1'
          MOLECULE_IMAGE: ${{ matrix.image }}
          MOLECULE_PLAYBOOK: converge_service_enabled.yml

      - name: Run Molecule tests (service user)
        run: source .venv/bin/activate && molecule test
        env:
          PY_COLORS: '1'
          ANSIBLE_FORCE_COLOR: '1'
          MOLECULE_IMAGE: ${{ matrix.image }}
          MOLECULE_PLAYBOOK: converge_service_user.yml

      - name: Run Molecule tests (proxy disabled)
        run: source .venv/bin/activate && molecule test
        env:
          PY_COLORS: '1'
          ANSIBLE_FORCE_COLOR: '1'
          MOLECULE_IMAGE: ${{ matrix.image }}
          MOLECULE_PLAYBOOK: converge_service_user.yml

      - name: Run Molecule tests (bind mounts)
        run: source .venv/bin/activate && molecule test
        env:
          PY_COLORS: '1'
          ANSIBLE_FORCE_COLOR: '1'
          MOLECULE_IMAGE: ${{ matrix.image }}
          MOLECULE_PLAYBOOK: converge_bind_mounts.yml

      - name: Run Molecule tests (alertmanager receivers)
        run: source .venv/bin/activate && molecule test
        env:
          PY_COLORS: '1'
          ANSIBLE_FORCE_COLOR: '1'
          MOLECULE_IMAGE: ${{ matrix.image }}
          MOLECULE_PLAYBOOK: converge_alertmanager_receivers.yml
